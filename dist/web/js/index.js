(()=>{"use strict";const t="end";function e(e){const n={apiVerion:"1.0",enterState:e.documentElement.getAttribute("start-state"),terminator:t,description:"",properties:{},states:{}},s=e.getElementsByTagName("state");for(let t=0;t<s.length;t++){let e=s[t],i={type:"decision",connectors:[],external:{}};o(e,i),n.states[e.getAttribute("name")]={type:i.type,description:e.getAttribute("title"),properties:{},connectors:i.connectors},Object.keys(i.external).forEach((t=>{n.states[t]||(n.states[t]=i.external[t])}))}return n}function o(e,o){const n={},s=[];for(let t=0;t<e.childNodes.length;t++){let n=e.childNodes.item(t);"event"!==n.tagName?"state-transition"!==n.tagName?"flow-transition"===n.tagName&&(o.external=o.external||{},o.external["#"+n.getAttribute("subflow")]={type:"external",description:"",properties:{},connectors:[{name:"#return",to:e.getAttribute("name")}]},i({name:n.getAttribute("name"),to:"#"+n.getAttribute("subflow")})):i({name:n.getAttribute("name"),to:n.getAttribute("to")}):o.type="process"}function i(t){n[t.to]?n[t.to].name+=", "+t.name:(n[t.to]=t,s.push(t))}s.length<=1&&"decision"===o.type&&(o.type="process"),!s.length&&i({name:"#link?",to:t}),s.forEach((t=>o.connectors.push(t)))}let n,s;function i(t,e,o,n,s,i){t.beginPath(),t.lineWidth=2,t.strokeStyle="#003300",t.rect(r(o,n,s,i),a(o,n,s,i),i.width,i.height),t.stroke(),function(t,e,o){t.beginPath(),t.arc(e,o,4,0,2*Math.PI,!1),t.fillStyle="#ffffff",t.fill(),t.strokeStyle="#003300",t.stroke()}(t,e.outgoingArrows[0].x,e.outgoingArrows[0].y),function(t,e,o){t.beginPath(),t.arc(e,o,4,0,2*Math.PI,!1),t.fillStyle="#000000",t.fill(),t.strokeStyle="#003300",t.stroke()}(t,e.incomingArrows[0].x,e.incomingArrows[0].y);let h=l(o,n,s,i),d=c(o,n,s,i)+45;t.font="14px Arial",t.fillStyle="#000000",t.fillText(e.name,h,d)}function r(t,e,o,s){let i=2*Math.PI/e*(t+1),r=n.height/2-o.offset;return o.x+r*Math.cos(i)-s.width/2}function a(t,e,o,s){let i=2*Math.PI/e*(t+1),r=n.height/2-o.offset;return o.x+r*Math.sin(i)-s.height/2}function l(t,e,o,n){return r(t,e,o,n)+5}function c(t,e,o,n){return a(t,e,o,n)-25}function h(t,e,o,n){t.stateColumns[e][o].rectCoordinateX=t.stateBounds.width+t.stateBounds.width*e*2,t.stateColumns[e][o].rectCoordinateY=(t.bounds.y-(2*t.stateColumns[e].length-1)*t.stateBounds.height)/2+t.stateBounds.height*o*2,t.stateColumns[e][o].cellPositionX=e,t.stateColumns[e][o].cellPositionY=o,n.beginPath(),n.lineWidth=2,n.strokeStyle="#000000",n.rect(t.stateColumns[e][o].rectCoordinateX,t.stateColumns[e][o].rectCoordinateY,t.stateBounds.width,t.stateBounds.height),n.stroke(),n.font="14px Arial",n.fillStyle="#000000",n.fillText(t.stateColumns[e][o].name,t.stateColumns[e][o].rectCoordinateX+10,t.stateColumns[e][o].rectCoordinateY+15)}function d(t,e,o){t.srcColNum>t.destColNum?(t.srcY-=e.stateBounds.height/3.5,t.destY-=e.stateBounds.height/3.5):t.srcColNum<t.destColNum&&(t.srcY+=e.stateBounds.height/3.5,t.destY+=e.stateBounds.height/3.5);let n=t.srcColNum<t.destColNum?t.srcX+t.connectorCentralOffsetX+.65*e.stateBounds.width:t.srcX+t.connectorCentralOffsetX-.65*e.stateBounds.width;o.beginPath(),o.moveTo(t.srcX,t.srcY),o.lineTo(n,t.srcY),o.stroke(),o.beginPath(),o.moveTo(n,t.srcY),o.lineTo(n,t.destY),o.stroke(),o.beginPath(),o.moveTo(n,t.destY),o.lineTo(t.destX,t.destY),o.stroke();const s=t.srcColNum<t.destColNum?0:Math.PI;o.beginPath(),o.moveTo(t.destX,t.destY),o.lineTo(t.destX-20*Math.cos(s-Math.PI/7),t.destY-20*Math.sin(s-Math.PI/9)),o.stroke(),o.beginPath(),o.moveTo(t.destX,t.destY),o.lineTo(t.destX-20*Math.cos(s+Math.PI/7),t.destY-20*Math.sin(s+Math.PI/9)),o.stroke()}function g(t,e,o){if(!t)return e.createTextNode("");if("object"!=typeof t)return e.createTextNode(t);const n=o&&e.createElementNS(o,t.tag)||e.createElement(t.tag);return Object.keys(t.attributes||{}).forEach((e=>{n.setAttribute(e,t.attributes[e])})),t.children?.forEach((t=>{n.appendChild(g(t,e,o))})),n}const u={gridSize:5,shapeHeight:40,shapeWidth:80,strokeColor:"#000000",bgColor:"#CCCCFF",textColor:"#000000",fontFace:"sans-serif",fontSize:10},f={};function m(t,e,o=u){const n={};Object.keys(u).forEach((t=>{n[t]=o[t]+""&&o[t]||u[t]}));const s=[0,0];this.getShapes=()=>f,this.position=(t,e)=>(s[0]=t,s[1]=e,this),this.render=()=>{if(!e)return;const o=f[e.type](t,e,n);return o.attributes.id="state-"+e.type+"/"+t,o.attributes.transform="translate("+s.join(" ")+")",o.x=s[0],o.y=s[1],o}}f.process=(t,e,o=u)=>{const n=o.shapeWidth,s=o.shapeHeight;return{width:n,height:s,tag:"g",attributes:{transform:"translate(0 0)"},children:[{tag:"rect",attributes:{x:0,y:0,width:n,height:s,rx:.5*o.gridSize,ry:.5*o.gridSize,fill:o.bgColor,stroke:o.strokeColor}},{tag:"text",attributes:{x:o.gridSize,y:3*o.gridSize,fill:o.textColor,"font-size":o.fontSize,"font-family":o.fontFace},children:[t]},{tag:"text",attributes:{x:o.gridSize,y:5*o.gridSize,"font-size":o.fontSize,"font-family":o.fontFace},children:[e.description&&"("+e.description+")"]}]}},f.decision=(t,e,o=u)=>{const n=o.shapeWidth,s=o.shapeHeight;return{width:16*o.gridSize,height:8*o.gridSize,tag:"g",attributes:{transform:"translate(0 0)"},children:[{tag:"path",attributes:{d:["M",0,s/2,"L",n/2,0,"L",n,s/2,"L",n/2,s,"z"].join(" "),fill:o.bgColor,stroke:o.strokeColor}},{tag:"text",attributes:{x:4*o.gridSize,y:3*o.gridSize,fill:o.textColor,"font-size":o.fontSize,"font-family":o.fontFace},children:[t]},{tag:"text",attributes:{x:4*o.gridSize,y:5*o.gridSize,"font-size":o.fontSize,"font-family":o.fontFace},children:[e.description&&"("+e.description+")"]}]}},f.external=(t,e,o=u)=>{const n=o.shapeWidth,s=o.shapeHeight;return{width:n,height:s,tag:"g",attributes:{transform:"translate(0 0)"},children:[{tag:"path",attributes:{d:["M",0,0,"L",n-2*o.gridSize,0,"L",n,s/2,"L",n-2*o.gridSize,s,"L",0,s,"z"].join(" "),fill:o.bgColor,stroke:o.strokeColor}},{tag:"text",attributes:{x:o.gridSize,y:3*o.gridSize,fill:o.textColor,"font-size":o.fontSize,"font-family":o.fontFace},children:[t]},{tag:"text",attributes:{x:o.gridSize,y:5*o.gridSize,"font-size":o.fontSize,"font-family":o.fontFace},children:[e.description&&"("+e.description+")"]}]}},f.enter=f.end=(t,e,o=u)=>{const n=12*o.gridSize,s=3*o.gridSize,i=s/2;return{width:n,height:s,tag:"g",attributes:{transform:"translate(0 0)"},children:[{tag:"path",attributes:{d:["M",i,0,"L",n-i,0,"A",i,i,0,0,1,n-i,s,"L",i,s,"A",i,i,0,0,1,i,0].join(" "),fill:"white",stroke:o.strokeColor}},{tag:"text",attributes:{x:o.gridSize,y:2*o.gridSize,fill:o.textColor,"font-size":o.fontSize,"font-family":o.fontFace},children:[t]}]}};const p={rowHeight:60,columnWidth:80,turnRadius:15,marginLeft:10,marginTop:10,textBoxLength:15,gridSize:5,shapeHeight:40,shapeWidth:80,strokeColor:"#000000",bgColor:"#CCCCFF",textColor:"#000000",fontFace:"sans-serif",fontSize:10};function y(t,e,o=p){const n={};Object.keys(p).forEach((t=>{n[t]=o[t]+""&&o[t]||p[t]}));const s={tag:"g",attributes:{transform:"translate(0 0)"},children:[]},i={tag:"svg",attributes:{version:"1.1",xmlns:"http://www.w3.org/2000/svg"},children:[s]},r=[],a={};function l(e,o,i,d,g){let u=t.states[o],f=!1;if(!u){if(o!==t.terminator)return void console.warn("State ["+o+"] not found");u={type:"end"},f=!0}const p=new m(o,u,n).position(d*n.columnWidth,i*n.rowHeight).render();p.joins=c(p),s.children.push(p),!f&&(a[o]=p),r[i]=p,p.length=d,p.column=d,p.row=i,s.children.push(h(e,p,g)),u.connectors?.forEach((t=>{let e=t.to;a[e]?s.children.push(h(p,a[e],t.name)):l(p,e,r.length,d+1,t.name)}))}function c(t){const e=t.x,o=t.y,n=t.width,s=t.height;return{left:{x:e,y:o+s/2},bottom:{x:e+n/2,y:o+s},right:{x:e+n,y:o+s/2},top:{x:e+n/2,y:o}}}function h(t,e,o){return t.x<e.x&&t.y<e.y?function(t,e,o){const s=t.joins.bottom,i=e.joins.left,r=n.gridSize,a=n.turnRadius;let l=0,c=e.row*n.rowHeight;return{tag:"g",attributes:{id:"connector-forward/"+o},children:[{tag:"path",attributes:{d:["M",s.x,s.y,"L",l=s.x,i.y-a,"A",a,a,0,0,0,s.x+a,i.y,"L",i.x,i.y].join(" "),fill:"none",stroke:n.strokeColor}},{tag:"path",attributes:{d:["M",i.x,i.y,"L",i.x-2*r,i.y-r,"L",i.x-2*r,i.y+r,"Z"].join(" ")},fill:n.strokeColor,stroke:n.strokeColor},d(o,1,l+n.gridSize,c-n.gridSize)]}}(t,e,o):function(t,e,o){const s=t.joins.top,i=e.joins.right,a=n.gridSize,l=n.turnRadius,c=n.columnWidth;let h=t.column+1;for(let o=e.row;o<t.row;o++)r[o].length>=t.length&&(h=t.length=r[o].length+1);let g=0,u=0,f=0,m=0;return{tag:"g",attributes:{id:"connector-backward/"+o},children:[{tag:"path",attributes:{d:["M",g=s.x,u=s.y,"A",l,l/2,0,0,1,g+=l,u-=l/2,"L",g=h*c,u,"A",l,l,0,0,0,g+=l,u-=l,"L",f=g,m=u=i.y+l,"A",l,l,0,0,0,g-=l,i.y,"L",i.x,i.y].join(" "),fill:"none",stroke:n.strokeColor}},{tag:"path",attributes:{d:["M",i.x,i.y,"L",i.x+2*a,i.y-a,"L",i.x+2*a,i.y+a,"z"].join(" "),fill:n.strokeColor,stroke:n.strokeColor}},d(o,1,f+n.gridSize,m)]}}(t,e,o)}function d(t="",e=1,o=0,s=0){const i=t.split(/\s/),r=[];let a="";return i.forEach((t=>{if(a=a?a+" "+t:t,a.length>=e){let t;r.push(t={tag:"tspan",attributes:{x:o,dy:n.fontSize},children:[a]}),n.textBoxLength<a.length&&(t.attributes["font-size"]=n.fontSize*n.textBoxLength/a.length),a=""}})),{tag:"text",attributes:{x:o,y:s-n.fontSize*r.length,"font-size":n.fontSize,"font-family":n.fontFace},children:r}}this.draw=function(){const o=new m("start",{type:"enter"},n).position(n.marginLeft,n.marginTop).render();o.joins=c(o),s.children.push(o),l(o,t.enterState,1,1);const a=r.filter((t=>t)).map((t=>t.length)).sort(((t,e)=>e-t))[0]+1||0;return i.attributes.height=r.length*n.rowHeight,i.attributes.width=a*n.columnWidth+2*n.marginLeft,g(i,e,"http://www.w3.org/2000/svg")}}function C(){const t=document.createElement("canvas");return t.width=1300,t.height=1300,t}var x,w;(x={ace,buttons:[{title:"circle chart (png)",action:t=>{const o=C();return function(t,e){n={width:e.width,height:e.height};let o=e.getContext("2d");const s={x:n.width/2,y:n.height/2,offset:80},r={width:190,height:50},a=Object.keys(t.states).length;o.clearRect(0,0,o.canvas.width,o.canvas.height);let h={stateViews:{}},d=0;for(let e in t.states){let n={name:e,nextStates:t.states[e].connectors.map((t=>t.to)),incomingArrows:[],outgoingArrows:[]},g=c(d,a,s,r)+s.offset;g>s.y&&(g-=r.height);let u=c(d,a,s,r)+s.offset-r.height/2,f=l(d,a,s,r)+r.width/2;f<s.x?f+=r.width/2:f-=r.width/2,n.outgoingArrows.push({x:l(d,a,s,r)+r.width/2,y:g}),n.incomingArrows.push({x:f,y:u}),i(o,n,d,a,s,r),h.stateViews[n.name]=n,d++}Object.keys(h.stateViews).forEach((t=>{let e=Array(),n=h.stateViews[t];for(let t=0;t<n.nextStates.length;t++){let o=n.nextStates[t],s=h.stateViews[o];if(s){let t=s.incomingArrows[0];e.push({srcX:n.outgoingArrows[0].x,srcY:n.outgoingArrows[0].y,destX:t.x,destY:t.y})}}e.forEach((t=>function(t,e){e.beginPath(),e.moveTo(t.srcX,t.srcY),e.lineTo(t.destX,t.destY),e.stroke();const o=Math.atan2(t.destY-t.srcY,t.destX-t.srcX);e.beginPath(),e.moveTo(t.destX,t.destY),e.lineTo(t.destX-20*Math.cos(o-Math.PI/7),t.destY-20*Math.sin(o-Math.PI/9)),e.stroke(),e.beginPath(),e.moveTo(t.destX,t.destY),e.lineTo(t.destX-20*Math.cos(o+Math.PI/7),t.destY-20*Math.sin(o+Math.PI/9)),e.stroke()}(t,o)))}))}(e(t),o),o},type:"img"},{title:"flow chart (png)",action:t=>{const o=C();return function(t,e){s={width:e.width,height:e.height};let o={bounds:{x:0,y:0},stateBounds:{width:190,height:150},stateColumns:Array()},n=[t.enterState],i=!0,r=0;for(o.stateColumns.push([{model:t.states[t.enterState],name:t.enterState}]);i;){let e=Array();i=!1;for(let s=0;s<o.stateColumns[o.stateColumns.length-1].length;s++){let r=o.stateColumns[o.stateColumns.length-1][s].model;for(let o=0;o<r?.connectors?.length;o++)if("end"!==r.connectors[o].to&!n.includes(r.connectors[o].to)){n.push(r.connectors[o].to),i=!0;let s={model:t.states[r.connectors[o].to],name:r.connectors[o].to};e.push(s)}}e.length>0&&(o.stateColumns.push(e),e.length>r&&(r=e.length))}Object.keys(t.states).forEach((e=>{n.includes(e)||o.stateColumns.push([{model:t.states[e],name:e}])})),o.bounds.x=o.stateBounds.width*(2*o.stateColumns.length+1),o.bounds.y=o.stateBounds.height*(2*r+1),e.width=o.bounds.x,e.height=o.bounds.y;const a=e.getContext("2d");s.width=e.width,s.height=e.height;let l={};a.fillStyle="#eeeeee",a.fillRect(0,0,o.bounds.x,o.bounds.y),a.stroke();for(let t=0;t<o.stateColumns.length;t++)for(let e=0;e<o.stateColumns[t].length;e++)h(o,t,e,a),l[o.stateColumns[t][e].name]={x:o.stateColumns[t][e].rectCoordinateX,y:o.stateColumns[t][e].rectCoordinateY,cellPositionX:t,cellPositionY:e,freeIncomingPosition:1};for(let t=0;t<o.stateColumns.length;t++){let e=0;for(let n=0;n<o.stateColumns[t].length;n++){let s=0;for(let i=0;i<o.stateColumns[t][n].model?.connectors?.length;i++){if(l[o.stateColumns[t][n].model.connectors[i].to]){let r=o.stateColumns[t][n].rectCoordinateX+o.stateBounds.width,c=o.stateColumns[t][n].rectCoordinateY+o.stateBounds.height/2,h=l[o.stateColumns[t][n].model.connectors[i].to].x,g=l[o.stateColumns[t][n].model.connectors[i].to].y+o.stateBounds.height/2;h<r&&(r-=o.stateBounds.width,h+=o.stateBounds.width),d({srcX:r,srcY:c+s,destX:h,destY:g+s-10*l[o.stateColumns[t][n].model.connectors[i].to].freeIncomingPosition,srcColNum:t,srcRowNum:n,destColNum:l[o.stateColumns[t][n].model.connectors[i].to].cellPositionX,connectorCentralOffsetX:e,connectorCentralOffsetY:s},o,a)}s+=5,e+=5,l[o.stateColumns[t][n].model.connectors[i].to]&&l[o.stateColumns[t][n].model.connectors[i].to].freeIncomingPosition++}}}}(e(t),o),o},type:"img"},{title:"tree chart (svg)",action:t=>new y(e(t),document).draw(),type:"svg"}]},w=[function(t){return new W3View(t).setRegistry({"APP-ROOT":{prep:{tgn:"MAIN",as:"app-root",attr:{as:"app-root"},ch:[{tgn:"TABLE",attr:{style:"width: 100%;"},ch:[{tgn:"TBODY",attr:{},ch:[{tgn:"TR",attr:{style:"vertical-align: top;"},ch:[{tgn:"TD",attr:{style:"height:300px;"},ch:[{tgn:"DIV",attr:{style:"width:100%;height:100%;",_ref:"source"},ch:[]}]},{tgn:"TD",attr:{style:"width:100px;height:300px;"},ch:[{tgn:"ARRAY-ITERATOR",attr:{_ref:"controls"},ch:[{tgn:"CONTROL-BUTTON",attr:{},ch:[]}]},{tgn:"DIV",attr:{style:"padding-top: 20px; font-size: 12px;;"},ch:["\n                    Вставь xml в поле слева и нажми на одну из кнопок\n                "]}]},{tgn:"TD",attr:{class:"report",style:"width: 250px;height:300px;color:#FFFFFF;padding:0 30px;",_ref:"report"},ch:[{tgn:"DIV",attr:{},ch:["Всего состояний: 100"]}]}]}]}]},{tgn:"DIV",attr:{_ref:"chartView"},ch:[]}],script:function(t,e,o,n){const s=t.ace.edit(this.ref.source);s.setTheme("ace/theme/monokai"),s.session.setMode("ace/mode/xml"),s.getOption("optionName"),this.ref.source.style.fontSize="14px",this.ref.source.style.fontFamily="'Courier New', Courier, monospace'",this.ref.controls.setData(t.buttons,{target:this.ref.chartView,editor:s})}}},"CONTROL-BUTTON":{prep:{tgn:"BUTTON",as:"control-button",attr:{as:"control-button"},ch:[],script:function(t,e,o,n){const s={img:"img-container",svg:"svg-container"},i=new DOMParser;this.onSetData=(t,o)=>{this.innerHTML=t.title,this.onclick=()=>{Array.prototype.slice.call(o.target.children).forEach((t=>{t.destroy()}));const n=o.editor.getValue();if(!n?.trim())return;const r=i.parseFromString(n,"text/xml"),a=t.action(r),l=e.create(s[t.type]);l.setData(a),l.mount(o.target)}}}}},"IMG-CONTAINER":{prep:{tgn:"DIV",as:"img-container",attr:{as:"img-container",style:"overflow:scroll;background-color: white;"},ch:[],script:function(t,e,o,n){this.onSetData=t=>{t.style.width="100%",this.appendChild(t)}}}},"SVG-CONTAINER":{prep:{tgn:"DIV",as:"svg-container",attr:{as:"svg-container",style:"background-color: white;"},ch:[],script:function(t,e,o,n){this.onSetData=t=>{this.appendChild(t)}}}}})}(x)],w[0]).create("app-root").mount(document.body)})();